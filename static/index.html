<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kisten-Management üì¶</title>
    <style>
        :root {
            --primary: #4f46e5;
            --bg: #f9fafb;
            --card: #ffffff;
            --text: #111827;
        }

        body {
            font-family: 'Inter', system-ui, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            color: var(--primary);
        }

        /* Form-Design */
        .form-card {
            background: var(--card);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }

        input {
            width: 100%;
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            box-sizing: border-box;
        }

        button {
            width: 100%;
            background: var(--primary);
            color: white;
            padding: 12px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        button:hover {
            opacity: 0.9;
        }

        /* Listen-Design */
        .box-list {
            display: grid;
            gap: 15px;
        }

        .box-card {
            background: var(--card);
            padding: 15px;
            border-radius: 8px;
            border-left: 5px solid var(--primary);
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 1px 3px rgb(0 0 0 / 0.1);
        }

        .delete-btn {
            background: #ef4444;
            width: auto;
            padding: 8px 12px;
            font-size: 12px;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>Kisten-Verwaltung üì¶</h1>

        <!-- Formular zum Hinzuf√ºgen -->
        <div class="form-card">
            <h3>Neue Kiste hinzuf√ºgen</h3>
            <div class="form-group">
                <label>Code (z.B. K-001)</label>
                <input type="text" id="code" placeholder="Code eingeben...">
            </div>
            <div class="form-group">
                <label>Ort (z.B. Keller)</label>
                <input type="text" id="location" placeholder="Ort eingeben...">
            </div>
            <div class="form-group">
                <label>Inhalt</label>
                <input type="text" id="content" placeholder="Was ist drin?">
            </div>
            <button onclick="addBox()">Kiste speichern</button>
        </div>

        <!-- Statistik & Filter Bereich -->
        <div class="stats-container" style="display: flex; gap: 20px; margin-bottom: 20px;">
            <div class="form-card" style="flex: 1; margin-bottom: 0;">
                <h3>üìä Statistik</h3>
                <div id="statsOutput">Lade Daten...</div>
            </div>

            <div class="form-card" style="flex: 1; margin-bottom: 0;">
                <h3>üîç Suche / Filter</h3>
                <div class="form-group">
                    <label>Nach Ort filtern:</label>
                    <input type="text" id="filterLocation" placeholder="z.B. Keller" oninput="loadBoxes()">
                </div>
            </div>
        </div>

        <!-- Liste der Kisten -->
        <h3>Alle Kisten</h3>
        <div id="boxList" class="box-list">
            <!-- Wird per JavaScript gef√ºllt -->
        </div>
    </div>

    <script>
        // Funktion: Alle Kisten laden (mit optionalem Filter)
        async function loadBoxes() {
            const filterLoc = document.getElementById('filterLocation').value;
            let url = '/boxes';
            if (filterLoc) {
                url += '?location=' + encodeURIComponent(filterLoc);
            }

            const response = await fetch(url);
            const boxes = await response.json();
            const listElement = document.getElementById('boxList');
            listElement.innerHTML = '';

            if (boxes.length === 0) {
                listElement.innerHTML = '<p style="color: grey; text-align: center;">Keine Kisten gefunden.</p>';
                return;
            }

            boxes.forEach(box => {
                listElement.innerHTML += `
                    <div class="box-card">
                        <div>
                            <strong>${box.code}</strong> <span style="color:white; background:var(--primary); padding: 2px 6px; border-radius:4px; font-size: 0.8em;">${box.location}</span><br>
                            <small>${box.content}</small>
                        </div>
                        <button class="delete-btn" onclick="deleteBox('${box.code}')">L√∂schen</button>
                    </div>
                `;
            });

            // Auch Statistik aktualisieren wenn sich was √§ndert
            loadStats();
        }

        // Funktion: Statistik laden
        async function loadStats() {
            try {
                const response = await fetch('/stats');
                const data = await response.json();

                let statsHtml = `<strong>Gesamt: ${data.total_boxes} Kisten</strong><br><br>`;
                statsHtml += '<ul style="padding-left: 20px; margin: 0;">';
                for (const [loc, count] of Object.entries(data.locations)) {
                    statsHtml += `<li>${loc}: ${count}</li>`;
                }
                statsHtml += '</ul>';

                document.getElementById('statsOutput').innerHTML = statsHtml;
            } catch (e) {
                console.error("Statistik Fehler", e);
            }
        }

        // Funktion: Neue Kiste senden
        async function addBox() {
            const code = document.getElementById('code').value;
            const location = document.getElementById('location').value;
            const content = document.getElementById('content').value;

            const response = await fetch('/boxes', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ code, location, content })
            });

            if (response.ok) {
                // alert('Kiste wurde gespeichert!'); // Alert nervt beim Testen, wir laden einfach neu
                loadBoxes();
                document.getElementById('code').value = '';
                document.getElementById('location').value = '';
                document.getElementById('content').value = '';
            } else {
                const err = await response.json();
                alert('Fehler: ' + err.error);
            }
        }

        // Funktion: Kiste l√∂schen
        async function deleteBox(code) {
            if (confirm('M√∂chtest du die Kiste ' + code + ' wirklich l√∂schen?')) {
                await fetch('/boxes/' + code, { method: 'DELETE' });
                loadBoxes();
            }
        }

        // Beim Starten der Seite Kisten laden
        loadBoxes();
    </script>
</body>

</html>